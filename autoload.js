class AutoLoad{#t=[{}];#e;#i=null;#s;#r;#a;#n;#h;#l;#o;#d=null;#c=null;#m;#p=[];#u=null;#g;#C;#w;#f;#y=null;#v=null;#b;#I=!0;#R="main";#S;#T;#W=0;#L=0;#A;#$=1;#P;#x;#O;#M=!0;#D=!0;#k=!0;#H;#F;#N;#E;#G;#j;#U=!0;#V;#z;#B=[];constructor(t,e){this.#s=e,this.#s.style.overflow="hidden",Array.isArray(t)?"[object Object]"!==Object.prototype.toString.call(t[0])?this.#B.push("Invalid Data | Data is Not An Array Object | Data must be Array Object"):(this.#t=t,this.dataLength=this.#t.length):this.#B.push("Invalid Data | Data is Not An Array | Data must be Array Object"),this.POSITIONS={LEFT:"justify-content: flex-start;",RIGHT:"justify-content: flex-end;",CENTER:"justify-content: center;",BETWEEN:"justify-content: space-between;",AROUND:"justify-content: space-around;",EVENLY:"justify-content: space-evenly;"}}config(t={}){this.#e=this.#t,this.#P=t.perLoad||20,this.#H=t.lazyloadImageColor||"#eee",this.#V=t.autoloadWhen||10,this.#h=t.gridGap||"10px",this.#o=t.gridItemMinWidth||"200px",this.#l=t.gridItemWidth||"fit",t.gridItemMinWidth&&t.gridItemMinWidth.endsWith("%")&&this.errors.push("In gridItemMinWidth % percentage is not allowed"),t.gridItemWidth&&t.gridItemWidth.endsWith("%")&&this.errors.push("In gridItemWidth % percentage is not allowed"),this.#C=t.listGap||"10px",this.#f=t.listItemMinWidth||"500px",this.#w=t.listItemWidth||"fit",t.listItemMinWidth&&t.listItemMinWidth.endsWith("%")&&this.errors.push("In listItemMinWidth % percentage is not allowed"),t.listItemWidth&&t.listItemWidth.endsWith("%")&&this.errors.push("In listItemWidth % percentage is not allowed"),this.searchIn=t.searchIn||"all",this.searchCaseSensitive=t.searchCaseSensitive||!1,this.#b=document.createElement("div"),this.#b.id="ViewSearchContainer",this.#s.append(this.#b),this.#F=t.position||this.POSITIONS.LEFT,this.#x=this.#q(),this.columns=Object.keys(this.#t[0]),this.selected=[],this.inSelection=!1,this.#A={grid:1,list:1,table:1},this.#S={grid:0,list:0,table:0},this.#T={grid:0,list:0,table:0},this.#i=new Templator({lazyloadImageColor:this.#H}),this.#G=new IntersectionObserver((t=>{const e=t.length;for(let i=0;i<e;i++)if(t[i].isIntersecting){const e=t[i].target;e.src=e.dataset.viewLoadimg,e.style.visibility="visible",this.#G.unobserve(e)}}),{rootMargin:"120px"}),this.#U&&(this.#j=new IntersectionObserver((t=>{const e=t[0];e.isIntersecting&&("main"==this.#R?this.#A[this.#a]<this.#x?(this.beforeAutoload&&this.beforeAutoload(),this.#Y(!1),this.#j.unobserve(e.target),this.autoloaded=!0,this.#A[this.#a]++):this.autoloaded=!1:"search"==this.#R&&(this.#$<this.#O?(this.beforeAutoload&&this.beforeAutoload(),this.#Y(!1),this.autoloaded=!0,this.#$++):this.autoloaded=!1))}),{rootMargin:t.autoloadMargin||"0px"})),setTimeout((()=>{this.#b.style.display="grid",this.#b.style.position="relative",this.apiSearching=t.apiSearching||!1,this.searchApi=t.searchApi||"",this.searchApiOptions=t.searchApiOptions||{},this.apiSearching&&(""==this.searchApi?this.#B.push("Search API Url not provided for fetching data."):"string"!=typeof this.searchApi?this.#B.push("Invalid Search API Url"):this.searchApi.startsWith("http")||this.searchApi.startsWith("https")||this.#B.push("Invalid Search API Url .Protocol not Provided")),this.#N=t.autoFetch||!1,this.#E=t.autoFetchWhen||40,this.dataApiUrl=t.dataApiUrl||"",this.dataApiOptions=t.dataApiOptions||{},this.#N&&(""==this.dataApiUrl?this.#B.push("Data API Url not provided for fetching data."):"string"!=typeof this.dataApiUrl?this.#B.push("Invalid Data API Url"):this.dataApiUrl.startsWith("http")||this.dataApiUrl.startsWith("https")||this.#B.push("Invalid Data API Url .Protocol not Provided")),this.#z=t.autoCleanupWhen||100,window.addEventListener("resize",(()=>{this.#r==this.#n?this.#Q():this.#r==this.#g&&this.#J()}))}),500)}get errors(){return this.#B}get register(){const t=this;return{templator(e){t.#i.register(e)}}}set listItemTemplate(t){if(this.#B.length>0)return;if(!(t=t.trim()).startsWith("<"))return this.#B.push("Invalid List Item Template"),"";const e=t.indexOf("<"),i=t.indexOf(" ",e),s=-1!==i?i:t.indexOf(">",e);let r=t.slice(e+1,s).toLowerCase();if(r=-1!=r.lastIndexOf(">")?r.slice(0,-2):r,!t.endsWith(`</${r}>`))return this.#B.push("Invalid List Item Template"),"";this.#v=r,this.#y=this.#i.oneTimeParse(t),this.#g=document.createElement("div"),this.#g.id="ViewListContainer",this.listContainerClass="data-view-list",this.#g.className=this.listContainerClass,this.#g.style.display="none",this.#g.style.gap=this.#C,this.#g.style.position="relative",this.#s.append(this.#g),this.#J()}set gridItemTemplate(t){if(this.#B.length>0)return;if(!(t=t.trim()).startsWith("<")||t.startsWith("< "))return this.#B.push("Invalid Grid Item Template"),"";const e=t.indexOf("<"),i=t.indexOf(" ",e),s=-1!==i?i:t.indexOf(">",e);let r=t.slice(e+1,s).toLowerCase();if(r=-1!=r.lastIndexOf(">")?r.slice(0,-2):r,!t.endsWith(`</${r}>`))return this.#B.push("Invalid Grid Item Template"),"";this.#c=r,this.#d=this.#i.oneTimeParse(t),this.#n=document.createElement("div"),this.#n.id="ViewGridContainer",this.gridContainerClass="data-view-grid",this.#n.className=this.gridContainerClass,this.#n.style.display="none",this.#n.style.gap=this.#h,this.#n.style.position="relative",this.#s.append(this.#n),this.#Q()}set tableRowHtml(t){if(!(this.#B.length>0)){if(!(t=t.trim()).startsWith("<"))return this.#B.push("Invalid Table Row Template"),"";this.#u=this.#i.oneTimeParse(t),this.#m=document.createElement("table"),this.#m.id="ViewTableContainer",this.#m.style.position="relative",this.tableClass="data-view-table table",this.#m.className=this.tableClass,this.#m.createTBody(),this.#m.style.display="none",this.#s.append(this.#m)}}set tableColumns(t){if(null==this.#u)return this.#B.push("Please Set Table Row Template First."),null;this.#p=t;let e=this.#m.createTHead(),i="<tr>";for(let t=0;t<this.#p.length;t++)i+=`<th>${this.#p[t]}</th>`;i+="</tr>",e.innerHTML=i}set view(t){if(this.#a==t)return"This view is already set.";if(this.inSelection)return"You are in Selection Mode";const e=this.#a;if(this.#a=t,"search"==this.#R)return"table"==this.#a?(this.#b.style.display="none",this.#r=this.#m,this.#r.style.display="table"):(this.#m.style.display="none",this.#K(this.#a),this.#r=this.#b,this.#r.style.display="grid"),this.#W=0,this.#L=0,this.#$=1,void this.#Y();switch(t){case"grid":if(null==this.#d)return this.#B.push("Please Set Grid Item Template First."),null;this.#g&&(this.#g.style.display="none"),this.#m&&(this.#m.style.display="none"),this.#n.style.display="grid",this.#r=this.#n,this.#M&&(this.#T[this.#a]=this.#S[this.#a],this.#Y()),this.#I=!0;break;case"list":if(null==this.#y)return this.#B.push("Please Set List Item Template First."),null;this.#n&&(this.#n.style.display="none"),this.#m&&(this.#m.style.display="none"),this.#g.style.display="grid",this.#r=this.#g,this.#D&&(this.#T[this.#a]=this.#S[this.#a],this.#Y()),this.#I=!0;break;case"table":if(null==this.#u)return this.#B.push("Please Set Table Row Template First."),null;this.#n&&(this.#n.style.display="none"),this.#g&&(this.#g.style.display="none"),this.#m.style.display="table",this.#r=this.#m,this.#k&&(this.#T[this.#a]=this.#S[this.#a],this.#Y());break}this.#T[e]>=this.#z&&this.cleanUp(e)}cleanUp(t){this.#S[t]=0,this.#T[t]=0,this.#A[t]=0,"grid"==t?(this.#n.innerHTML="",this.#M=!0):"list"==t?(this.#g.innerHTML="",this.#D=!0):"table"==t&&(this.#m.tBodies[0].innerHTML="",this.#k=!0)}async search(t){if(this.inSelection)return"You are in Selection Mode";if(""==t)return"grid"==this.#a?(this.#r=this.#n,this.#n.style.display="grid"):"list"==this.#a?(this.#r=this.#g,this.#g.style.display="grid"):"table"==this.#a&&(this.#r=this.#m,this.#m.style.display="table"),this.#b.style.display="none",this.#e=this.#t,this.#$=1,this.#R="main",(this.#M||this.#D||this.#k)&&this.#Y(),this.#b.innerHTML="",void(this.searchQuery=null);if(this.#I&&(this.#I=!1,this.#K()),this.apiSearching){const e=this.searchApi.replace(/{(.*?)}/g,((e,i)=>"query"==i?t:"searchCaseSensitive"==i?this.searchCaseSensitive:"column"==i?this.searchIn:"last"==i||"last:index"==i?this.dataLength-1:"last:counter"==i?this.dataLength:i.startsWith("last:")?this.#t[this.dataLength-1][i.slice(5)]?.toString().replace(/ /g,"%20"):"perLoad"==i?this.#P:void 0));let i=await fetch(e,this.searchApiOptions);try{i=await i.json(),this.afterSearching?this.#e=this.afterSearching(i):this.#e=i}catch(t){this.afterSearching&&(this.errors.push(t),this.afterSearching(t))}}else this.#e=this.#t.filter((e=>"all"==this.searchIn?this.searchCaseSensitive?JSON.stringify(e).includes(t):JSON.stringify(e).toLowerCase().includes(t.toLowerCase()):this.searchCaseSensitive?String(e[this.searchIn]).includes(t):String(e[this.searchIn]).toLowerCase().includes(t.toLowerCase())));this.#r!=this.#b&&("grid"==this.#a?this.#n.style.display="none":"list"==this.#a?this.#g.style.display="none":"table"==this.#a&&(this.#m.style.display="none"),"table"==this.#a?(this.#r=this.#m,this.#r.style.display="table"):(this.#r=this.#b,this.#r.style.display="grid")),this.#W=0,this.#L=0,this.#$=1,this.#R="search",this.#Y(),this.searchQuery=t,this.#O=this.#q()}render(t="grid"){switch(this.#a=t,t){case"grid":if(null==this.#d)return this.#B.push("Please Set Grid Item Template First."),null;this.#n.style.display="grid",this.#r=this.#n;break;case"list":if(null==this.#y)return this.#B.push("Please Set List Item Template First."),null;this.#g.style.display="grid",this.#r=this.#g;break;case"table":if(null==this.#u)return this.#B.push("Please Set Table Row Template First."),null;null==this.#m.tHead&&this.#B.push("Please Set Table Headings First With tableColumns Which Is Setter Method."),this.#m.style.display="table",this.#r=this.#m,this.#I=!1;break}this.#Y()}async#X(){let t,e,i;if("main"==this.#R?(t=this.#T[this.#a],e=this.dataLength,i=this.dataApiUrl):(t=this.#L,e=this.#e.length,i=this.searchApi.replace(/{(.*?)}/g,((t,e)=>"query"==e?this.searchQuery:"searchCaseSensitive"==e?this.searchCaseSensitive:"column"==e?this.searchIn:void 0))),e-(t+1)<=this.#E&&e>=this.#P){this.beforeAutofetch&&this.beforeAutofetch();const t=i.replace(/{(.*?)}/g,((t,e)=>"last"==e||"last:index"==e?this.dataLength-1:"last:counter"==e?this.dataLength:e.startsWith("last:")?this.#t[this.dataLength-1][e.slice(5)]?.toString().replace(/ /g,"%20"):"perLoad"==e?this.#P:void 0));let e=await fetch(t,this.dataApiOptions);try{let t;e=await e.json(),t=this.afterAutofetch?this.afterAutofetch(e):e,"main"==this.#R?(this.#t=this.#t.concat(t),this.#e=this.#t):this.#e=this.#e.concat(t),this.autoloaded||(this.#Y(!1),this.autoloaded=!0,"main"==this.#R?this.#A[this.#a]++:this.#$++),"main"==this.#R?(this.#x=this.#q(),this.dataLength+=t.length):this.#O=this.#q()}catch(t){this.afterAutofetch&&this.afterAutofetch(t),this.errors.push(t)}}}#Y(t=!0){if(this.errors.length>0)return;let e,i,s;if("main"==this.#R?(i=t?this.#S[this.#a]:++this.#T[this.#a],s=this.#T[this.#a]):"search"==this.#R&&(i=t?this.#W:++this.#L,s=this.#L),"grid"==this.#a){if(null==this.#d)return this.#B.push("Please Set Grid Item Template First."),null;e=this.#d}else if("list"==this.#a){if(null==this.#y)return this.#B.push("Please Set List Item Template First."),null;e=this.#y}else if("table"==this.#a){if(null==this.#u)return this.#B.push("Please Set Table Row Template First."),null;e=this.#u}let r,a=this.#P+s;const n=document.createDocumentFragment(),h=document.createElement("tbody");for(r=i;r<a&&null!=this.#e[r];r++)h.insertAdjacentHTML("beforeend",this.#i.parseOnEveryRow(e,this.#e[r],r)),n.appendChild(h.firstChild);"search"==this.#R?this.#L=--r:this.#T[this.#a]=--r;let l=this.#r;"table"==this.#a&&(l=l.tBodies[0]),t?(l.innerHTML="",l.appendChild(n)):l.appendChild(n),this.afterAutoload&&this.afterAutoload(),setTimeout((()=>{"main"==this.#R?"grid"==this.#a?this.#M=!1:"list"==this.#a?this.#D=!1:"table"==this.#a&&(this.#k=!1):"table"==this.#a&&(this.#k=!0);const t=document.querySelectorAll(`#${this.#r.id} img[data-view-loadimg]`),e=t.length;for(let i=0;i<e;i++)this.#G.observe(t[i]);if("table"==this.#a){const t=Array.from(this.#r.rows);t.at(-this.#V)?this.#j.observe(t.at(-this.#V)):this.#j.observe(t.at(-1))}else{const t=Array.from(this.#r.children);t.at(-this.#V)?this.#j.observe(t.at(-this.#V)):this.#j.observe(t.at(-1))}}),70),this.#N&&setTimeout((()=>{this.#X()}),110),this.inSelection&&setTimeout((()=>{this.#Z(i,this.#T[this.#a])}),80)}#Z(t,e){const i=this.selectionOptions;if(this.#r==this.#m){const s=this.#r.rows;if(0==t)s[0].insertCell(0).innerHTML=`<input type="checkbox" class="${i.class}" selection="all">`;for(let r=t;r<=e&&null!=s[r+1];r++){s[r+1].insertCell(0).innerHTML=`<input type="checkbox" class="${i.class}" selection="${r}">`}}else{const s=this.#r.children;if(null==s[t]){const t=this.#r.querySelectorAll("input[selection]"),e=t.length,r=t.length+this.#P;for(let t=e;t<=r&&null!=s[t];t++)s[t].insertAdjacentHTML("afterbegin",`<input type="checkbox" class="${i.class}" selection="${t}" style="position: absolute;top: ${i.top};right:${i.right};bottom:${i.bottom};left: ${i.left};z-index: 5;">`)}else for(let r=t;r<=e&&null!=s[r];r++)s[r].insertAdjacentHTML("afterbegin",`<input type="checkbox" class="${i.class}" selection="${r}" style="position: absolute;top: ${i.top};right:${i.right};bottom:${i.bottom};left: ${i.left};z-index: 5;">`)}}startSelection(t=!1,e={}){e.top=e?.top||"10px",e.right=e?.right||"auto",e.bottom=e?.bottom||"auto",e.left=e?.left||"10px",e.class=e?.class||"selection",this.selectionOptions=e,this.inSelection=!0,this.#r.rows?this.#Z(0,this.#r.rows.length-1):this.#Z(0,this.#r.children.length-1),this.#s.onclick=e=>{let i;if(e.preventDefault(),i=this.#r==this.#n?e.target.closest(`#ViewGridContainer > ${this.#c}`):this.#r==this.#g?e.target.closest(`#ViewListContainer > ${this.#v}`):e.target.closest("tbody tr"),i){const s=i.querySelector("input[selection]");if(e.target==s)return;if(!s)return;s.checked=!s.checked;const r=Number(s.getAttribute("selection"));s.checked?(this.selected.push({index:r,data:this.#e[r]}),s.setAttribute("checked",!0)):(s.removeAttribute("checked"),this.selected.splice(this.selected.findIndex((t=>t.index==r)),1)),0!=t&&t({index:r,element:i,checked:s.checked})}else{const e=this.#r.querySelector("input[selection=all]");if(e){const i=this.#r.querySelectorAll("input[selection]"),s=i.length-1;if(e.checked)for(let t=0;t<s;t++){const e=i[t+1];this.selected.push({index:t,data:this.#e[t]}),e.setAttribute("checked",!0),e.checked=!0}else for(let t=0;t<s;t++){const e=i[t+1];e.removeAttribute("checked"),e.checked=!1,this.selected.splice(this.selected.findIndex((e=>e.index==t)),1)}0!=t&&t({checked:e.checked})}}}}stopSelection(){this.selected=[],this.inSelection=!1;const t=this.#r.querySelectorAll("input[selection]"),e=t.length;if(this.#r.rows)for(let i=0;i<e;i++)t[i].parentElement.remove();else for(let i=0;i<e;i++)t[i].remove();this.#s.onclick=null}updateData(t){this.#t=t(this.#t)}#K(t=null){this.#r.id==this.#n.id||"grid"==t?(this.#b.style.gap=this.#h,this.#Q(this.#b)):this.#r.id==this.#g.id||"list"==t?(this.#b.style.gap=this.#C,this.#J(this.#b)):this.#b.style.gridTemplateColumns="repeat(1,1fr)"}#Q(t=this.#n){let e="";if("fit"==this.#l){e=`\n                #${t.id} > ${this.#c}{\n                    min-width:${this.#o};\n                }\n                `;let i=Math.floor(this.#s.offsetWidth/(parseInt(this.#o.match(/\d*/)[0])+parseInt(this.#h.match(/\d*/)[0])));t.style.gridTemplateColumns=`repeat(${i},1fr)`}else{e=`\n                #${t.id}{\n                    ${this.#F}\n                }\n                #${t.id} > ${this.#c}{\n                    min-width:${this.#o};\n                    width:100%;\n                    max-width:${this.#l};\n                }\n                `;let i=Math.floor(this.#s.offsetWidth/parseInt(this.#l.match(/\d*/)[0]));t.style.gridTemplateColumns=`repeat(${i},${this.#l})`}if(null==document.getElementById("DataViewStyle")){const t=document.createElement("style");t.id="DataViewStyle",t.textContent+=e,this.#s.append(t)}else document.getElementById("DataViewStyle").textContent+=e}#J(t=this.#g){let e="";if("fit"==this.#w){e=`\n                #${t.id} > ${this.#v}{\n                    min-width:${this.#f};\n                }\n                `;let i=Math.floor(this.#s.offsetWidth/(parseInt(this.#f.match(/\d*/)[0])+parseInt(this.#C.match(/\d*/)[0])));t.style.gridTemplateColumns=`repeat(${i},1fr)`}else{e=`\n                #${t.id}{\n                    ${this.#F}\n                }\n                #${t.id} > ${this.#v}{\n                    min-width:${this.#f};\n                    width:100%;\n                    max-width:${this.#w};\n                }\n                `;let i=Math.floor(this.#s.offsetWidth/parseInt(this.#w.match(/\d*/)[0]));t.style.gridTemplateColumns=`repeat(${i},${this.#w})`}if(null==document.getElementById("DataViewStyle")){const t=document.createElement("style");t.id="DataViewStyle",t.textContent+=e,this.#s.append(t)}else document.getElementById("DataViewStyle").textContent+=e}#q(){return Math.ceil(this.#e.length/this.#P)}}class Templator{#_;#H;#tt;#et;#it;templator=null;constructor(t){this.#_={formatNum:this.formatNum},this.#H=t.lazyloadImageColor,this.#tt=/{%(.[^{%]*?)%}/g,this.#et=/\{%if\s+(.*?)\s+%}(.*?){%else%}(.*?){%endif%}/gs,this.#it={upper:t=>t.toUpperCase(),lower:t=>t.toLowerCase(),firstCap:t=>t[0].toUpperCase()+t.slice(1).toLowerCase(),length:(t,e)=>t.slice(0,Number(e)+1),formatNum:t=>this.formatNum(t)}}register(t){this.templator=new t(this.#_)}oneTimeParse(t){let e=t;null!=this.templator&&null!=this.templator.oneTimeParse&&(e=this.templator.oneTimeParse(e));const i=new Date;e=t.replace(/{{(.*?)}}/g,((t,e)=>{const[s,r]=e.split(":"),[,...a]=null!=r?r.split("|"):"";let n=t;switch(s){case"date":switch(r){case"y":n=i.getFullYear();break;case"m":n=i.getMonth()+1;break;case"d":n=i.getDate();break;default:n=`${i.getDate()}-${i.getMonth()+1}-${i.getFullYear()}`;break}break;case"time":const t=new Date;switch(r){case"h":n=t.getHours();break;case"m":n=t.getMinutes();break;case"s":n=t.getSeconds();break;default:n=`${t.getHours()}:${t.getMinutes()}:${t.getSeconds()}`;break}break}return n}));return e=e.replace(/{{loadimage\|(.*?)>}}/g,((t,e)=>{let[i,s]=e.split("|"),r="";return s?.startsWith("<img")||(r=`width:${s};`,s=e.split("|")[2]),s?.match(/style=('|")(.*?)/)?s=`${s.slice(0,s.match(/style="?'?(.*?)/).index+7)}width:100%;height:100%;visibility:hidden;${s.slice(s.match(/style="?'?(.*?)/).index+7)}>`:s+=' style="width:100%;height:100%;visibility:hidden;">',s=s.replace(/src=('|")(.*?)('|")/,((t,e,i)=>`data-view-loadimg="${i}"`)),`<div style="${r}height:${i};background:${this.#H};">${s}</div>`})),e}parseOnEveryRow(t,e,i){let s=t;return null!=this.templator&&null!=this.templator.parseOnEveryRow&&(s=this.templator.parseOnEveryRow(s,e,i)),s=s.replace(this.#et,((t,i,s,r)=>{const[,a]=i.split(":");if(null==e[a])return;const n=a.match(/\[([^)]+)\]/);return(n?e[a.slice(0,n?.index)][n[1]]:e[a])?s:r?r.trim():""})),s=s.replace(this.#tt,((t,s)=>{const[r,a,n]=s.split(":"),[h,l]=null!=a?a.split("|"):"";switch(r){case"counter":return i+1;case"column":if(null==e[h])return;const t=h.match(/\[([^)]+)\]/),s=t?e[h.slice(0,t?.index)][t[1]]:e[h];return this.#it[l]?this.#it[l](s):s}})),s}formatNum(t){let e=t.toString().split("");return 5==e.length&&"."!=e[2]?e.splice(2,0,","):"."!=e[3]&&e.length>3&&e.splice(3,0,","),-1!=e.indexOf(".")&&e.length>e.indexOf(".")+2&&(e.length=e.indexOf(".")+2),e.join("")}}module.exports=AutoLoad;